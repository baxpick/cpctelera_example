name: Build and Push Docker Image (CPC)

# Grant permissions for the reusable workflow to push packages
permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/reusable-docker-build-push.yml'
      - '.github/workflows/docker-build-push-cpc.yml'
      - 'docker/Dockerfile.cpc'
      - 'docker/entrypoint.sh'
      - 'docker/build_cpctelera_project_from_container.sh'
  workflow_dispatch: # Allows manual triggering
  repository_dispatch:
    types: [ enterprise-port-push ]

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Set up build matrix
      id: set-matrix
      run: |
        # Use JSON variable or default to single build config
        MATRIX='${{ vars.CPC_BUILD_MATRIX }}'
        if [ -z "$MATRIX" ]; then
          MATRIX='[{"repo_url":"https://github.com/lronaldo/cpctelera.git","branch":"development","image_version":"development-latest"}]'
        fi
        # Compact JSON to single line (remove newlines and extra spaces)
        MATRIX=$(echo "$MATRIX" | jq -c .)
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
      shell: bash

  build-and-push-cpc:
    needs: setup-matrix
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    uses: ./.github/workflows/reusable-docker-build-push.yml
    with:
      dockerfile: ./docker/Dockerfile.cpc
      image_name: braxpix/cpctelera-build-cpc
      image_version: ${{ matrix.config.image_version }}
      build_args: |
        CPC_REPO_URL=${{ matrix.config.repo_url }}
        CPC_REPO_BRANCH=${{ matrix.config.branch }}
      acr_login_server: acrbaxosprod.azurecr.io
      acr_image_name: cpctelera-build-cpc
    secrets:
      DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      ACR_USERNAME: ${{ secrets.TF_VAR_ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.TF_VAR_ACR_PASSWORD }}
